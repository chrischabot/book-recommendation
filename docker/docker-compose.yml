services:
  postgres:
    image: pgvector/pgvector:pg16
    shm_size: 4gb
    environment:
      POSTGRES_USER: books
      POSTGRES_PASSWORD: books
      POSTGRES_DB: books
    # Tuned for bulk data loading performance
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=256MB
      -c work_mem=64MB
      -c maintenance_work_mem=512MB
      -c max_wal_size=4GB
      -c checkpoint_timeout=30min
      -c checkpoint_completion_target=0.9
      -c synchronous_commit=off
      -c wal_buffers=64MB
      -c effective_cache_size=1GB
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U books -d books"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7-alpine
    profiles: ["cache"]
    ports:
      - "6379:6379"
    volumes:
      - redisdata:/data

volumes:
  pgdata: {}
  redisdata: {}
